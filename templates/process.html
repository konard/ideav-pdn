<link rel="stylesheet" href="/download/{_global_.z}/process.css" />
<script src="/download/{_global_.z}/process.js"></script>

<!-- Notification Panel -->
<div id="notificationPanel" class="notification-panel">
    <span id="notificationMessage"></span>
</div>

<div class="container-fluid pt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <h4 class="mb-2 mb-md-0">Процессы обработки ПДн</h4>
                    <div class="d-flex align-items-center flex-wrap">
                        <div class="search-container mr-3 mb-2 mb-md-0">
                            <input type="text"
                                   class="form-control"
                                   id="searchInput"
                                   placeholder="Поиск по любому полю..."
                                   style="min-width: 250px;">
                        </div>
                        <button class="btn btn-primary" onclick="openAddForm()">
                            <i class="bi bi-plus-circle mr-1"></i> Добавить
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Загрузка...</span>
                        </div>
                        <p class="mt-3 text-muted">Загрузка процессов...</p>
                    </div>

                    <!-- Process Cards Grid -->
                    <div id="processGrid" class="row" style="display: none;"></div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <p class="text-muted">Список процессов пуст</p>
                    </div>

                    <!-- No Results State -->
                    <div id="noResultsState" class="text-center py-5" style="display: none;">
                        <p class="text-muted">Ничего не найдено по запросу "<span id="searchQuery"></span>"</p>
                    </div>

                    <!-- Pagination -->
                    <nav id="paginationNav" aria-label="Навигация по страницам" style="display: none;">
                        <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
                    </nav>

                    <!-- Items Counter -->
                    <div id="itemsCounter" class="text-center text-muted mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Card Template -->
<template id="processCardTemplate">
    <div class="col-lg-4 col-md-6 col-sm-12 mb-3 process-card-col">
        <div class="card process-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <a href="#" class="process-title text-primary font-weight-bold" onclick="openEditForm(this); return false;" data-process-id=""></a>
                    <small class="text-muted process-id"></small>
                </div>
                <div class="process-details">
                    <p class="mb-1"><span class="text-muted">Группа:</span> <span class="process-group">—</span></p>
                    <p class="mb-1"><span class="text-muted">Кол-во субъектов:</span> <span class="process-subjects">—</span></p>
                    <p class="mb-1"><span class="text-muted">Дата создания:</span> <span class="process-date">—</span></p>
                    <p class="mb-0"><span class="text-muted">Создатель:</span> <span class="process-creator">—</span></p>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Process Form Modal -->
<div class="modal fade" id="processFormModal" tabindex="-1" role="dialog" aria-labelledby="processFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processFormModalLabel">Новый процесс</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="formTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="general-tab" data-toggle="tab" href="#generalTab" role="tab">Общая информация</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="is-tab" data-toggle="tab" href="#isTab" role="tab">ИС</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="purpose-tab" data-toggle="tab" href="#purposeTab" role="tab">Цель обработки</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="method-tab" data-toggle="tab" href="#methodTab" role="tab">Способ обработки</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="pdn-tab" data-toggle="tab" href="#pdnTab" role="tab">ПДн</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="expertise-tab" data-toggle="tab" href="#expertiseTab" role="tab">Экспертиза</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="risks-tab" data-toggle="tab" href="#risksTab" role="tab">Риски</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="transfer-tab" data-toggle="tab" href="#transferTab" role="tab">Передача</a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content pt-3" id="formTabContent">
                    <!-- Общая информация -->
                    <div class="tab-pane fade show active" id="generalTab" role="tabpanel">
                        <div class="form-group">
                            <label for="processName">Процесс *</label>
                            <textarea class="form-control" id="processName" rows="2" placeholder="Название процесса"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="processStatus">Статус</label>
                            <select class="form-control" id="processStatus"></select>
                            <div id="additionalFieldsStatus" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processGroup">Группа</label>
                            <select class="form-control" id="processGroup"></select>
                            <div id="additionalFieldsGroup" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processParent">Родительский процесс</label>
                            <select class="form-control" id="processParent"></select>
                        </div>
                        <div class="form-group">
                            <label for="processInitiator">Инициатор</label>
                            <select class="form-control" id="processInitiator"></select>
                            <div id="additionalFieldsInitiator" class="additional-fields" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- ИС -->
                    <div class="tab-pane fade" id="isTab" role="tabpanel">
                        <div class="form-group">
                            <label for="processProduct">Продукт</label>
                            <select class="form-control" id="processProduct"></select>
                            <div id="additionalFieldsProduct" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processService">Сервис</label>
                            <select class="form-control" id="processService"></select>
                            <div id="additionalFieldsService" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processIS">ИС</label>
                            <select class="form-control" id="processIS"></select>
                            <div id="additionalFieldsIS" class="additional-fields" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Цель обработки -->
                    <div class="tab-pane fade" id="purposeTab" role="tabpanel">
                        <div class="form-group">
                            <label for="processPurpose">Цель обработки ПДн</label>
                            <select class="form-control" id="processPurpose"></select>
                            <div id="additionalFieldsPurpose" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processMicroPurpose">Микроцель обработки ПДн</label>
                            <select class="form-control" id="processMicroPurpose"></select>
                            <div id="additionalFieldsMicroPurpose" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processSubjectCategories">Категории субъектов ПДн</label>
                            <select class="form-control" id="processSubjectCategories" multiple size="5"></select>
                            <small class="form-text text-muted">Удерживайте Ctrl для выбора нескольких</small>
                        </div>
                        <div class="form-group">
                            <label for="processSubjectsCount">Количество субъектов ПДн</label>
                            <select class="form-control" id="processSubjectsCount"></select>
                            <div id="additionalFieldsSubjectsCount" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processLegalBasis">Основание обработки ПДн *</label>
                            <select class="form-control" id="processLegalBasis"></select>
                            <div id="additionalFieldsLegalBasis" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group" id="legalBasisOtherGroup" style="display: none;">
                            <label for="processLegalBasisOther">Укажите иное основание *</label>
                            <textarea class="form-control" id="processLegalBasisOther" rows="2" placeholder="Введите альтернативное основание обработки ПДн"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="processLegalAct">Реквизиты нормативного правового акта</label>
                            <textarea class="form-control" id="processLegalAct" rows="2" placeholder="Введите реквизиты"></textarea>
                        </div>
                    </div>

                    <!-- Способ обработки -->
                    <div class="tab-pane fade" id="methodTab" role="tabpanel">
                        <div class="form-group">
                            <label for="processMethod">Способ обработки ПДн</label>
                            <select class="form-control" id="processMethod"></select>
                            <div id="additionalFieldsMethod" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processTerm">Срок обработки ПДн</label>
                            <select class="form-control" id="processTerm"></select>
                            <div id="additionalFieldsTerm" class="additional-fields" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="processDestruction">Порядок уничтожения ПДн</label>
                            <textarea class="form-control" id="processDestruction" rows="2" placeholder="Опишите порядок уничтожения"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="processDestructionFile">Порядок уничтожения (файл)</label>
                            <input type="file" class="form-control-file" id="processDestructionFile">
                            <small class="form-text text-muted">Загрузка файлов в данной версии не поддерживается</small>
                        </div>
                    </div>

                    <!-- ПДн -->
                    <div class="tab-pane fade" id="pdnTab" role="tabpanel">
                        <div id="pdnTabContent" class="data-tab-content"></div>
                    </div>

                    <!-- Экспертиза -->
                    <div class="tab-pane fade" id="expertiseTab" role="tabpanel">
                        <div id="expertiseTabContent" class="data-tab-content"></div>
                    </div>

                    <!-- Риски -->
                    <div class="tab-pane fade" id="risksTab" role="tabpanel">
                        <div id="risksTabContent" class="data-tab-content"></div>
                    </div>

                    <!-- Передача -->
                    <div class="tab-pane fade" id="transferTab" role="tabpanel">
                        <div id="transferTabContent" class="data-tab-content"></div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="formError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveProcessBtn" onclick="saveProcess()">
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                    <span class="btn-text">Сохранить</span>
                </button>
            </div>
        </div>
    </div>
</div>
